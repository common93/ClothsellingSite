@* @model CheckoutViewModel *@
@model RazorpayCheckoutViewModel
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

@{
    var cart = ViewBag.Cart as List<ClothingStoreApp.Models.CartViewModel> ?? new();
    decimal total = ViewBag.Total == null ? 0 : (decimal)ViewBag.Total;
}

<div class="container d-flex justify-content-center mt-5 mb-5">
    <div class="card shadow-lg border-0 p-4" style="max-width: 450px; width:100%; border-radius: 12px;">

        <h3 class="text-center mb-4 fw-bold">Checkout</h3>

        @* 🔒 If cart is empty, stop processing *@
        @if (!cart.Any())
        {
            <div class="alert alert-warning fw-bold text-center">
                Your cart is empty!
            </div>

            <div class="text-center mt-3">
                <a href="/Product" class="btn btn-dark">Shop Now</a>
            </div>

            return;
        }

        <!-- Order Summary -->
        <div class="mb-4 p-3 border rounded bg-light">
            <h5 class="fw-bold mb-3">Order Summary</h5>

            @foreach (var item in cart)
            {
                <div class="d-flex justify-content-between mb-2">
                    <span>@item.ProductName x @item.ProductQuantity</span>
                    <span>₹@(item.ProductPrice* item.ProductQuantity)</span>
                </div>
            }

            <hr />

            <div class="d-flex justify-content-between fw-bold fs-5">
                <span>Total</span>
                <span>₹@total</span>
            </div>
        </div>

        <form method="post">
            <div class="form-floating mb-3">
                <input asp-for="CustomerName" class="form-control" placeholder="Enter your name" required />
                <label class="fw-semibold">Full Name</label>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Email" type="email" class="form-control" placeholder="name@example.com" required />
                <label class="fw-semibold">Email</label>
            </div>

            <div class="form-floating mb-4">
                <textarea asp-for="Address" class="form-control" placeholder="Delivery Address" style="height:110px;" required></textarea>
                <label class="fw-semibold">Address</label>
            </div>

            <!-- Payment Method -->
            <div class="mb-4">
                <label class="fw-semibold mb-2">Payment Method</label>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" asp-for="PaymentMethod" value="COD" checked>
                    <label class="form-check-label fw-semibold">Cash on Delivery (COD)</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" asp-for="PaymentMethod" value="Online"
                           id="pmOnline">
                    <label class="form-check-label fw-semibold">Online Payment (UPI / Card)</label>
                </div>


            </div>
            <div class="payment-section mt-5 text-center">

                <h3 class="fw-bold mb-2" style="font-size: 1.6rem;">Complete Payment</h3>

                <p class="mb-4 fw-bold" style="font-size: 1.8rem; color:#111;">
                    Amount: ₹@ViewBag.Total
                </p>
                <button id="payBtn"
                        class="btn w-100 py-3 fw-semibold rounded-3 shadow-sm pay-btn"
                        type="button">
                    <span id="payBtnText">Pay Now</span>
                    <span id="payBtnLoader" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                </button>
            </div>

        </form>
    </div>
</div>
<script>
    document.getElementById("payBtn").onclick = function (e) {
        e.preventDefault();

        // STEP 1: Create order from backend
        fetch("/Checkout/CreateOrder?amount=@total", {
            method: "POST"
        })
        .then(res => res.json())
        .then(order => {

            // STEP 2: Razorpay popup options
            var options = {
                "key": order.key,
                "amount": "@(total * 100)",
                "currency": "INR",
                "name": "Clothing Store",
                "description": "Order Payment",
                "order_id": order.orderId,

                "handler": function (response) {

                    // STEP 3: Send to backend for signature verify
                    fetch("/Checkout/Verify", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(response)
                    })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success)
                            window.location = result.redirect;
                        else
                            alert("Payment Failed. Try again.");
                    });
                }
            };

            var rzp = new Razorpay(options);
            rzp.open();
        });
    }
</script>
<style>
    .payment-section {
        background: #ffffff;
        padding: 25px 20px;
        border-radius: 12px;
        border: 1px solid #e9e9e9;
    }

    .pay-btn {
        background: linear-gradient(135deg, #0057ff, #007bff);
        color: #fff;
        font-size: 1.1rem;
        transition: all .25s ease;
        border: none;
    }

        .pay-btn:hover {
            background: linear-gradient(135deg, #0049d1, #006ae6);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 80, 255, 0.25);
        }

        .pay-btn:active {
            transform: scale(0.98);
            box-shadow: none;
        }
</style>