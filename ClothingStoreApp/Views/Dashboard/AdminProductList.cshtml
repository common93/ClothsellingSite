@model IEnumerable<ClothingStore.Core.Entities.Product>

@{
    var products = Model.ToList();
}

<style>
    /* ===========================
                   CARD LAYOUT
                   ===========================*/
    .product-card {
        border: 1px solid #ddd;
        border-radius: 12px;
        background: #fff;
        padding: 15px;
        transition: 0.2s;
        display: flex;
        flex-direction: column;
        height: auto;
    }

        .product-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

    .product-img {
        width: 100%;
        height: 200px;
        object-fit: contain;
        background: #f5f5f5;
        border-radius: 8px;
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 22px;
    }

    /* ===========================
                   PRICE STYLE
                   ===========================*/
    .price-tag {
        color: #1E88E5 !important;
        font-weight: 600;
        font-size: 17px;
        margin-bottom: 10px;
    }

    /* ===========================
                   SEARCH + CLEAR GROUP
                   ===========================*/

    .search-clear-group {
        display: flex;
        border-radius: 10px;
        overflow: hidden;
        margin-left: 10px;
    }

    .search-box-btn,
    .clear-box-btn {
        padding: 10px 18px;
        width: 110px;
        display: flex;
        flex-direction: column;
        align-items: center;
        white-space: nowrap;
        border: none;
        color: #fff !important;
        text-decoration: none !important;
    }

    /* Search Button */
    .search-box-btn {
        background: #212529 !important;
    }

        .search-box-btn:hover {
            background: #343A40 !important;
        }

    /* Clear Button */
    .clear-box-btn {
        background: #6C757D !important;
        text-decoration: none !important;
    }

        .clear-box-btn:hover {
            background: #5C636A !important;
            text-decoration: none !important;
        }

        .search-box-btn .icon,
        .clear-box-btn .icon {
            font-size: 20px;
        }

        .search-box-btn .text,
        .clear-box-btn .text {
            font-size: 14px;
            margin-top: 3px;
            text-decoration: none !important;
        }

    /* ===========================
                   EDIT / DELETE BUTTONS
                   ===========================*/

    .btn-edit {
        background-color: #20C997 !important;
        border-color: #20C997 !important;
        color: white !important;
        border-radius: 8px !important;
        padding: 6px 14px !important;
    }

        .btn-edit:hover {
            background-color: #12B886 !important;
        }

    .btn-delete {
        background-color: #FA5252 !important;
        border-color: #FA5252 !important;
        color: white !important;
        border-radius: 8px !important;
        padding: 6px 14px !important;
    }

        .btn-delete:hover {
            background-color: #E03131 !important;
        }

    /* ===========================
                   STOCK BUTTONS
                   ===========================*/
    .stock-btn {
        width: 34px;
        height: 34px;
        border: 1px solid #CED4DA;
        background: #FFF;
        border-radius: 6px;
        font-size: 18px;
        color: #495057;
        cursor: pointer;
        transition: 0.15s;
    }

        .stock-btn:hover {
            background: #F1F3F5;
            border-color: #ADB5BD;
        }

    .stock-value {
        font-size: 18px;
        font-weight: 600;
        width: 50px;
        text-align: center;
        color: #212529;
    }

    .stock-box {
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
        margin-top: 8px;
    }

    /* ===========================
                   PAGINATION
                   ===========================*/
    .pagination-btn,
    .pagination-active {
        padding: 6px 16px;
        border-radius: 50px;
        margin: 0 4px;
        font-size: 14px;
        text-decoration: none;
    }

    .pagination-btn {
        background: #E9ECEF;
        color: #495057 !important;
    }

        .pagination-btn:hover {
            background: #DEE2E6;
        }

    .pagination-active {
        background: #845EF7 !important;
        color: white !important;
    }

    .product-card .actions {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
</style>

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4 mt-3">
    <h2>Products</h2>
    <a class="btn btn-success" asp-action="Create">+ Add Product</a>
</div>

<!-- SEARCH BAR -->
<form class="mb-3" method="get" asp-action="AdminProductList">
    <div class="d-flex align-items-center">

        <input name="search" value="@ViewBag.Search"
               class="form-control"
               placeholder="Search..."
               style="border-radius: 10px;">

        <div class="search-clear-group">

            <button class="search-box-btn" type="submit">
                <span class="icon">🔍</span>
                <span class="text">Search</span>
            </button>

            @if (!string.IsNullOrEmpty(ViewBag.Search))
            {
                <a href="@Url.Action("AdminProductList")" class="clear-box-btn">
                    <span class="icon">❌</span>
                    <span class="text">Clear</span>
                </a>
            }
        </div>

    </div>
</form>

<!-- CATEGORY FILTER -->
<form method="get" asp-action="AdminProductList">
    <select name="category" class="form-select mb-4" onchange="this.form.submit()">
        <option value="">All Categories</option>
        @foreach (var cat in products.Select(x => x.ProductCategory).Distinct())
        {
            <option value="@cat" selected="@(ViewBag.Category == cat)">
                @cat
            </option>
        }
    </select>
</form>

<!-- PRODUCT GRID -->
<div class="product-grid">
    @foreach (var p in products)
    {
        <div class="product-card">

            <img src="@Url.Content(p.ProductImageUrl?.Replace("\\", "/"))"
                 class="product-img" />

            <!-- DESCRIPTION TOOLTIP ADDED HERE -->
            <h5 class="mt-2"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="@p.ProductDescription">
                @p.ProductName
            </h5>

            <p class="text-muted">@p.ProductCategory</p>

            <h6 class="price-tag">@p.ProductPrice.ToString("C")</h6>

            <div class="stock-box">
                <button class="stock-btn btn-minus" data-id="@p.ProductId">−</button>
                <span class="stock-value" id="stock-@p.ProductId">@p.ProductStockQuantity</span>
                <button class="stock-btn btn-plus" data-id="@p.ProductId">+</button>
            </div>

            <div class="actions">
                <a class="btn btn-edit btn-sm" asp-action="Edit" asp-route-id="@p.ProductId">Edit</a>
                <a class="btn btn-delete btn-sm" asp-action="Delete" asp-route-id="@p.ProductId">Delete</a>
            </div>

        </div>
    }
</div>

<!-- PAGINATION -->
<div class="mt-4 text-center">
    @for (int i = 1; i <= ViewBag.TotalPages; i++)
    {
        if (i == ViewBag.CurrentPage)
        {
            <a class="pagination-active"
               asp-action="AdminProductList"
               asp-route-page="@i"
               asp-route-search="@ViewBag.Search"
               asp-route-category="@ViewBag.Category">@i</a>
        }
        else
        {
            <a class="pagination-btn"
               asp-action="AdminProductList"
               asp-route-page="@i"
               asp-route-search="@ViewBag.Search"
               asp-route-category="@ViewBag.Category">@i</a>
        }
    }
</div>

@section Scripts {
    <script>
        /* =============================
           BOOTSTRAP TOOLTIP INIT
           =============================*/
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        /* =============================
           AJAX STOCK UPDATE
           =============================*/
        function updateStock(id, newVal) {
            fetch('/Dashboard/UpdateStock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${id}&newStock=${newVal}`
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) alert("Error updating stock");
                });
        }

        document.querySelectorAll(".btn-plus").forEach(btn => {
            btn.addEventListener("click", () => {
                let id = btn.dataset.id;
                let valEl = document.getElementById("stock-" + id);
                let value = parseInt(valEl.textContent) + 1;
                valEl.textContent = value;
                updateStock(id, value);
            });
        });

        document.querySelectorAll(".btn-minus").forEach(btn => {
            btn.addEventListener("click", () => {
                let id = btn.dataset.id;
                let valEl = document.getElementById("stock-" + id);
                let value = parseInt(valEl.textContent);
                if (value > 0) value--;
                valEl.textContent = value;
                updateStock(id, value);
            });
        });
    </script>
}
